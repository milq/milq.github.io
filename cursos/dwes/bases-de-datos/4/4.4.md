# 4.4. Manejo de transacciones ([↑](README.md))

_Contenido creado por Manuel Ignacio López Quintero_

En el desarrollo de aplicaciones web que interactúan con bases de datos, **PDO** ofrece una interfaz consistente y segura para realizar operaciones **SQL**. Uno de los aspectos más críticos en la gestión de bases de datos es el manejo de **transacciones**, ya que estas permiten asegurar la integridad y consistencia de los datos. Una transacción es un conjunto de operaciones SQL que se ejecutan como una unidad única. Si alguna de las operaciones dentro de la transacción falla, se deshacen todas las operaciones realizadas, garantizando que la base de datos no quede en un estado inconsistente.

En PDO, las transacciones permiten agrupar varias operaciones de base de datos en una sola **unidad lógica de trabajo**. Esto significa que todas las operaciones dentro de una transacción se ejecutarán completamente o no se ejecutarán en absoluto, lo que es fundamental para mantener la integridad de los datos. Al agrupar las operaciones de esta manera, se asegura que los cambios realizados sean atómicos: o se aplican todos los cambios o no se aplica ninguno. Esto es especialmente importante en situaciones donde las operaciones dependen unas de otras, como en transferencias de dinero entre cuentas.

Para comenzar una transacción en PDO, se utiliza el método `beginTransaction()`. Este método inicia una nueva transacción, suspendiendo el modo de *autocommit* de la conexión a la base de datos. A partir de este punto, cualquier operación SQL ejecutada no se confirmará automáticamente.

```php
$pdo->beginTransaction();
```

Después de iniciar una transacción, se pueden ejecutar varias operaciones SQL. Si todas las operaciones se completan correctamente y se desea confirmar la transacción, se utiliza el método `commit()`. Este método confirma todas las operaciones realizadas desde el comienzo de la transacción.

```php
$pdo->commit();
```

Sin embargo, si ocurre algún error durante la ejecución de las operaciones SQL y se necesita revertir todos los cambios realizados desde el inicio de la transacción, se utiliza el método `rollBack()`. Este método deshace todas las operaciones realizadas desde el comienzo de la transacción.

```php
$pdo->rollBack();
```

A continuación, se presenta un ejemplo completo que ilustra el manejo de transacciones en PDO:

```php
include 'connect_db.php';

try {
    $pdo->beginTransaction();

    $sql1 = "INSERT INTO usuarios (nombre, email) VALUES (:nombre, :email)";
    $sth1 = $pdo->prepare($sql1);
    $sth1->execute([':nombre' => 'Pedro', ':email' => 'pedro@ejemplo.com']);

    $usuario_id = $pdo->lastInsertId();

    $sql2 = "INSERT INTO cuentas (usuario_id, saldo) VALUES (:usuario_id, :saldo)";
    $sth2 = $pdo->prepare($sql2);
    $sth2->execute([':usuario_id' => $usuario_id, ':saldo' => 100]);

    $pdo->commit();
} catch (Exception $e) {
    $pdo->rollBack();
    echo "Fallo en la transacción: " . $e->getMessage();
}
```

En este ejemplo, se realiza primero una inserción en la tabla `usuarios` y luego otra inserción en la tabla `cuentas`. Si ambas operaciones se completan sin errores, se confirma la transacción con `commit`. Si ocurre algún error, se revierte la transacción con `rollBack` para asegurar que los datos permanezcan consistentes.

El manejo de transacciones en PDO también permite *nesting* (anidamiento), donde se pueden iniciar transacciones dentro de otras transacciones. Sin embargo, esto puede ser complejo y no todas las bases de datos lo soportan de la misma manera. Por lo tanto, es crucial entender cómo la base de datos subyacente maneja las transacciones anidadas.

## Propiedades ACID y niveles de aislamiento

En el contexto de **transacciones** con PDO, es relevante conocer las **propiedades ACID** (*Atomicity*, *Consistency*, *Isolation*, *Durability*) para asegurar la fiabilidad de las operaciones de base de datos. **Atomicidad** garantiza que todas las operaciones dentro de una transacción se completen o se deshagan. La **Consistencia** asegura que las transacciones lleven la base de datos de un estado válido a otro. El **Aislamiento** permite que las transacciones operen independientemente sin interferir unas con otras, y la **Durabilidad** asegura que los resultados de una transacción confirmada persisten incluso ante fallos del sistema.

Para manejar el aislamiento, se pueden utilizar cláusulas de bloqueo como `SELECT ... FOR UPDATE` y `SELECT ... LOCK IN SHARE MODE`. Ambas bloquean la actualización o eliminación de las filas seleccionadas hasta que la transacción se complete. Sin embargo, mientras que `SELECT ... LOCK IN SHARE MODE` permite que otras transacciones lean las filas seleccionadas, permitiendo un acceso compartido a los datos, `SELECT ... FOR UPDATE` evita que otras transacciones lean las filas bloqueadas, asegurando un control exclusivo hasta que la transacción termine.

Finalmente, para quienes buscan profundizar, se recomienda explorar [transacciones distribuidas](https://en.wikipedia.org/wiki/Distributed_transaction) y el [protocolo de dos fases (2PC)](https://en.wikipedia.org/wiki/Two-phase_commit_protocol), que permiten coordinar transacciones que abarcan múltiples bases de datos o servicios. Estas técnicas avanzadas son cruciales en arquitecturas de sistemas distribuidos, donde la integridad de los datos debe mantenerse a través de diferentes nodos y servicios.

_Contenido creado por Manuel Ignacio López Quintero_
