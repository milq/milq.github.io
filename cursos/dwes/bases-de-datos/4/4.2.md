# 4.2. Preparación y ejecución de consultas ([↑](README.md))

_Contenido creado por Manuel Ignacio López Quintero_

En la gestión de bases de datos utilizando **PHP** y **PDO**, la **preparación y ejecución de consultas** son etapas fundamentales que garantizan tanto la eficiencia como la seguridad de las operaciones. A continuación, se detalla el proceso de preparación y ejecución de consultas utilizando PDO en PHP.

Para preparar y ejecutar una consulta en PDO, primero se debe crear una instancia de la clase PDO. Supongamos que ya se tiene una conexión activa a la base de datos. El siguiente paso es usar el método `prepare` de la instancia PDO. Este método toma una consulta **SQL** como argumento y devuelve un objeto de la clase `PDOStatement`. Luego, se deben vincular los parámetros a la consulta preparada utilizando los métodos `bindParam` o `bindValue` del objeto `PDOStatement`. Finalmente, para ejecutar la consulta preparada, se utiliza el método `execute()` del objeto `PDOStatement`.

En PDO, existen dos tipos de marcadores de posición: **parámetros nombrados** (*named parameters*) y **parámetros con signo de interrogación** (*question mark parameters*). Los parámetros nombrados utilizan nombres específicos precedidos por dos puntos, como `:id`, mientras que los parámetros con signo de interrogación utilizan signos de interrogación (`?`) que se corresponden con los valores en el orden en que aparecen en la consulta.

```php
// Ejemplo con parámetros nombrados
$query = 'INSERT INTO videojuegos (id, nombre, fecha_lanzamiento) VALUES (:id, :nombre, :fecha)';
// Ejemplo con parámetros con signo de interrogación
$query = 'INSERT INTO videojuegos (id, nombre, fecha_lanzamiento) VALUES (?, ?, ?)';
```

En este ejemplo, se utilizarán parámetros nombrados. Para preparar una **consulta con varios parámetros**, se puede hacer de la siguiente manera:

```php
$query = 'INSERT INTO videojuegos (id, nombre, fecha_lanzamiento) VALUES (:id, :nombre, :fecha)';
$stmt = $pdo->prepare($query);
```

Una vez preparada la consulta, se deben **vincular los parámetros**. Esto se hace utilizando el método `bindParam` o `bindValue` del objeto `PDOStatement`. La diferencia principal entre estos métodos es que `bindParam` vincula una variable al marcador de posición y evalúa su valor en el momento de la ejecución, mientras que `bindValue` vincula el valor directamente.

```php
$id = 1;
$stmt->bindParam(':id', $id, PDO::PARAM_INT);
// o
$stmt->bindValue(':id', $id, PDO::PARAM_INT);
```

Supongamos que los valores a vincular son un entero, una cadena de texto y una fecha. En este caso, utilizamos `bindParam`. El siguiente paso es vincular los parámetros utilizando el método `bindParam` del objeto `PDOStatement`.

```php
$id = 1;
$nombre = 'Golden Axe';
$fecha = '1989-01-27';

$stmt->bindParam(':id', $id, PDO::PARAM_INT);
$stmt->bindParam(':nombre', $nombre, PDO::PARAM_STR);
$stmt->bindParam(':fecha', $fecha, PDO::PARAM_STR);
```

Después de vincular todos los parámetros necesarios, la consulta está lista para ser ejecutada. Para **ejecutar la consulta**, se utiliza el método `execute`, el cual no requiere argumentos si se han utilizado parámetros nombrados con `bindParam` o `bindValue`.

```php
$stmt->execute();
```

En caso de que se necesite ejecutar la **misma consulta varias veces** con diferentes valores, la preparación inicial de la consulta se puede reutilizar. Cada vez que se quiera ejecutar la consulta con nuevos valores, simplemente se actualizan los valores de los parámetros y se llama nuevamente a `execute`.

```php
$id = 2;
$nombre = 'Super Mario Kart';
$fecha = '1992-08-27';

$stmt->bindParam(':id', $id, PDO::PARAM_INT);
$stmt->bindParam(':nombre', $nombre, PDO::PARAM_STR);
$stmt->bindParam(':fecha', $fecha, PDO::PARAM_STR);
$stmt->execute();
```

También es posible pasar un *array* de parámetros directamente al método `execute` al momento de ejecutar la consulta, lo cual puede simplificar el código cuando se tienen varios parámetros. Por ejemplo, para actualizar un registro:

```php
$stmt = $pdo->prepare('UPDATE videojuegos SET nombre = :nombre, fecha_lanzamiento = :fecha WHERE id = :id');
$stmt->execute([':id' => 1, ':nombre' => 'Indiana Jones and the Fate of Atlantis', ':fecha' => '1992-06-26']);
```

Para eliminar un registro, se puede usar una consulta de manera similar:

```php
$stmt = $pdo->prepare('DELETE FROM videojuegos WHERE id = :id');
$stmt->execute([':id' => 2]);
```

Es importante manejar correctamente los **errores** al trabajar con consultas en PDO. Para ello, se puede utilizar un bloque `try`-`catch` que permita capturar excepciones y manejar errores de manera más controlada. A continuación, se muestra un ejemplo completo de `prepare` y `execute` con `try`-`catch`:

```php
require 'connect_db.php';

try {
    $query = 'INSERT INTO videojuegos (id, nombre, fecha_lanzamiento) VALUES (:id, :nombre, :fecha)';
    $stmt = $pdo->prepare($query);
    $stmt->execute([':id' => 3, ':nombre' => 'Sonic the Hedgehog', ':fecha' => '1991-06-23']);
    echo 'Registro insertado correctamente.';
} catch (PDOException $e) {
    echo 'Error: ' . $e->getMessage();
}
```

Para consultas de selección con `SELECT`, el proceso también es similar, aunque la obtención de resultados se verá más adelante.

En ocasiones, es útil conocer el identificador del último registro insertado o el número de filas afectadas por una consulta. Para obtener el identificador del último registro insertado, se puede utilizar el método `lastInsertId` de la instancia PDO. Para obtener el número de filas afectadas por una consulta, se utiliza el método `rowCount`.

A continuación, se muestra un ejemplo que utiliza ambos métodos:

```php
require 'connect_db.php';

try {
    // El campo 'id' de la tabla 'videojuegos' es autoincremental
    $query = 'INSERT INTO videojuegos (nombre, fecha_lanzamiento) VALUES (:nombre, :fecha)';
    $stmt = $pdo->prepare($query);
    $stmt->execute([':nombre' => 'The Legend of Zelda: Ocarina of Time', ':fecha' => '1998-11-21']);
    echo 'Registro insertado correctamente.<br /><br />';
    echo 'ID: ' . $pdo->lastInsertId() . '<br />';
    echo 'Filas afectadas: ' . $stmt->rowCount();
} catch (PDOException $e) {
    throw new Exception('Error: ' . $e->getMessage());
}
```

## Ejercicio

Crea una base de datos y una tabla denominada `videojuegos` utilizando el siguiente comando SQL:

```sql
CREATE TABLE videojuegos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100),
    fecha_lanzamiento DATE
);
```

A continuación, crea una página web llamada `index.php` que contenga un formulario para agregar un videojuego. El formulario debe incluir los siguientes campos: *Nombre* y *Fecha de lanzamiento*, junto con un botón con la etiqueta *Añadir*.

Al hacer clic en el botón *Añadir*, los datos del formulario se enviarán a `insertar.php`, donde se insertará el videojuego en la base de datos. Para ello, se utilizará **PDO** con las instrucciones `prepare` y `execute`, vinculando los parámetros mediante `bindParam`.

### Propuesta de solución (ve esta propuesta únicamente después de resolver el ejercicio por ti mismo)

Primero, se muestra una propuesta de solución para `index.php`:

```php
<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' lang='es'>
  <head>
    <meta charset='utf-8' />
    <title>Videojuego - Añadir</title>
  </head>
  <body>
    <h1>Videojuego - Añadir</h1>

    <form action='insertar.php' method='post'>
      <label for='nombre'>Nombre:</label>
      <input type='text' id='nombre' name='nombre' />

      <br /><br />

      <label for='fecha_lanzamiento'>Fecha de lanzamiento:</label>
      <input type='date' id='fecha_lanzamiento' name='fecha_lanzamiento' />

      <br /><br />

      <input type='submit' value='Añadir' />
    </form>
  </body>
</html>
```

Luego, se presenta una propuesta de solución para `insertar.php`:

```php
<?php

require 'connect_db.php';

try {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $nombre = filter_input(INPUT_POST, 'nombre', FILTER_SANITIZE_STRING);
        $fecha_lanzamiento = filter_input(INPUT_POST, 'fecha_lanzamiento', FILTER_SANITIZE_STRING);

        if (!empty($nombre) && strlen($nombre) <= 100 &&
            preg_match('/^\d{4}-\d{2}-\d{2}$/', $fecha_lanzamiento))
        {
            $stmt = $pdo->prepare(
                'INSERT INTO videojuegos (nombre, fecha_lanzamiento) VALUES (:nombre, :fecha_lanzamiento)');

            $stmt->bindParam(':nombre', $nombre, PDO::PARAM_STR);
            $stmt->bindParam(':fecha_lanzamiento', $fecha_lanzamiento, PDO::PARAM_STR);

            $stmt->execute();

            echo 'Videojuego añadido con éxito';
        } else {
            echo 'Datos inválidos.';
        }
    }
} catch (PDOException $e) {
    echo 'Error: ' . $e->getMessage();
}
```

El archivo `connect_db.php` sería el código de conexión a la base de datos mediante PDO:

```php
<?php

$host = 'localhost';
$db = 'nombre_base_datos';
$user = 'usuario';
$pass = 'contraseña';

$dsn = 'mysql:host=' . $host . ';dbname=' . $db;

try {
    $pdo = new PDO($dsn, $user, $pass);
} catch (PDOException $e) {
    echo 'Error: ' . $e->getMessage();
}
```

_Contenido creado por Manuel Ignacio López Quintero_
