# 3.3. Obtención y manejo de resultados ([↑](README.md))

_Contenido creado por Manuel Ignacio López Quintero_

La **obtención** y **manejo** de resultados en PHP utilizando MySQLi es fundamental en el desarrollo de aplicaciones que interactúan con bases de datos. Los resultados se pueden recoger de diversas maneras, utilizando métodos como `fetch_all`, `fetch_array` y `fetch_column` de la clase `mysqli_result`. Cada uno de estos métodos permite obtener los datos de la base de datos de forma eficiente y luego manejar los resultados según las necesidades específicas de la aplicación.

La clase **`mysqli_result`** es una representación de un conjunto de resultados obtenido desde una consulta SQL, y difiere de las clases `mysqli` y `mysqli_stmt`. Mientras que `mysqli` maneja la conexión a la base de datos y `mysqli_stmt` representa una sentencia preparada, `mysqli_result` almacena los datos devueltos por una consulta `SELECT`.

Para obtener una instancia de la clase `mysqli_result` desde una sentencia preparada, se puede utilizar el método `get_result` de la instancia `mysqli_stmt`. Este método devuelve un objeto `mysqli_result`. Por ejemplo:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT * FROM libros');
    $stmt->execute();
    $result = $stmt->get_result();
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

Para obtener todas las filas de una consulta, se utiliza el método **`fetch_all`**, que devuelve un *array* bidimensional con el conjunto de resultados. Este método tiene una constante por defecto `MYSQLI_NUM` que devuelve un *array* numérico. Por ejemplo:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT * FROM libros');
    $stmt->execute();
    $result = $stmt->get_result();
    $results = $result->fetch_all(); // Por defecto usa MYSQLI_NUM
    print_r($results);
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

En el código anterior, se recogen todos los resultados de una consulta SELECT y se imprimen en formato de *array* numérico. Existen otras opciones como `fetch_all(MYSQLI_ASSOC)`, que devuelve un *array* asociativo donde las claves son los nombres de las columnas, y `fetch_all(MYSQLI_BOTH)`, que devuelve tanto índices numéricos como asociativos.

Para obtener una única fila de una consulta en un *array* unidimensional, se emplea el método **`fetch_array`**. Este método devuelve un *array* con los datos de una fila, y por defecto utiliza `MYSQLI_BOTH`. Por ejemplo:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT * FROM libros WHERE id = ?');
    $stmt->bind_param('i', $id);
    $id = 1;
    $stmt->execute();
    $result = $stmt->get_result();
    $row = $result->fetch_array(MYSQLI_ASSOC);
    print_r($row);
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

En este ejemplo, se utiliza `fetch_array(MYSQLI_ASSOC)` para obtener los resultados en un *array* asociativo, también se podría utilizar el método `fetch_assoc` para el mismo propósito.

Para obtener un solo valor de una columna específica, se emplea el método **`fetch_column`**. Por ejemplo, para recoger el nombre específico de un libro:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT nombre FROM libros WHERE id = ?');
    $stmt->bind_param('i', $id);
    $id = 1;
    $stmt->execute();
    $result = $stmt->get_result();
    $name = $result->fetch_column();
    echo $name;
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

Una vez obtenidos los datos, se pueden **manejar los resultados** de diversas maneras, como presentarlos de forma visual en una tabla HTML. A continuación se presenta un ejemplo:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT nombre, autor FROM libros');
    $stmt->execute();
    $result = $stmt->get_result();
    $rows = $result->fetch_all(MYSQLI_ASSOC);

    echo '<table border="1">';
    echo '<tr><th>Nombre</th><th>Autor</th></tr>';

    foreach ($rows as $row) {
        echo '<tr>';
        echo '<td>' . htmlspecialchars($row['nombre']) . '</td>';
        echo '<td>' . htmlspecialchars($row['autor']) . '</td>';
        echo '</tr>';
    }

    echo '</table>';
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

Otra alternativa al ejemplo de arriba es utilizar `while ($row = $result->fetch_assoc()) { }` para iterar sobre los resultados fila por fila.

Cuando se manejan **grandes volúmenes de datos**, el uso del método `get_result` de la clase `mysqli_result` puede ser costoso en términos de memoria. Para procesar filas una por una y optimizar el uso de memoria, una opción es usar los métodos **`bind_result`** y **`fetch`** de la clase `mysqli_stmt`. Por ejemplo:

```php
require 'connect_db.php';

try {
    $stmt = $mysqli->prepare('SELECT nombre, autor FROM libros');
    $stmt->execute();
    $stmt->bind_result($nombre, $autor);
    echo '<table border="1">';
    echo '<tr><th>Nombre</th><th>Autor</th></tr>';
    while ($stmt->fetch()) {
        echo '<tr>';
        echo '<td>' . htmlspecialchars($nombre) . '</td>';
        echo '<td>' . htmlspecialchars($autor) . '</td>';
        echo '</tr>';
    }
    echo '</table>';
} catch (mysqli_sql_exception $e) {
    echo 'Error: ' . $e->getMessage();
}
```

Este enfoque es más eficiente en términos de memoria y es ideal para procesar grandes conjuntos de datos fila por fila.

_Contenido creado por Manuel Ignacio López Quintero_
