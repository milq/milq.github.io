# 5.1. Prevención de inyección SQL ([↑](README.md))

_Contenido creado por Manuel Ignacio López Quintero_

La [inyección SQL](https://en.wikipedia.org/wiki/SQL_injection) es una técnica de ataque en la que un atacante inserta código malicioso en una consulta SQL, con el objetivo de manipular la base de datos. Este tipo de ataque puede resultar en la divulgación no autorizada de datos, la modificación o eliminación de información y, en algunos casos, la toma de control total del sistema de base de datos.

Para ilustrar cómo funciona una **inyección SQL**, consideremos un ejemplo sencillo. Supongamos que una aplicación web tiene el siguiente código PHP para autenticar usuarios:

```php
$username = $_POST['username'];
$password = $_POST['password'];
$query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
$result = mysqli_query($conn, $query);
```

Si un atacante ingresa como `username` el siguiente valor: `' OR '1'='1' --`, la consulta resultante sería:

```php
SELECT * FROM users WHERE username = '' OR '1'='1' --' AND password = ''
```

La condición `OR '1'='1'` siempre es verdadera, lo que permite al atacante eludir la autenticación sin necesidad de conocer el nombre de usuario o la contraseña correctos.

Una forma efectiva de prevenir la **inyección SQL** es usar **consultas preparadas** con las funciones `prepare` y `execute`. Al emplear estas consultas, los parámetros se envían por separado del código SQL, evitando que los datos puedan ser interpretados como código. Esto significa que, incluso si un usuario malintencionado intenta insertar SQL malicioso en los campos de entrada, esos valores se tratarán únicamente como datos, eliminando el riesgo de inyección.

Ejemplo de uso de **PDO** con consultas preparadas:

```php
$stmt = $pdo->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
$stmt->execute(['username' => $username, 'password' => $password]);
```

En este código, los valores de `$username` y `$password` se vinculan de manera segura a la consulta, eliminando la posibilidad de inyección SQL.

Además de usar consultas preparadas, existen otras medidas adicionales que pueden ayudar a mejorar la seguridad de la base de datos. Una es **validar** y **sanitizar** todas las entradas del usuario, lo cual se verá en la siguiente sección.

Otra práctica recomendada es limitar los **privilegios de las cuentas de la base de datos**. No todas las aplicaciones necesitan acceso completo a la base de datos. Asignar el menor nivel de privilegios necesarios puede minimizar el impacto de un ataque exitoso. Por ejemplo, una cuenta utilizada para operaciones de solo lectura no debe tener permisos de escritura.

Ejemplo de cómo asignar privilegios mínimos a una cuenta de usuario en MySQL o MariaDB:

```sql
CREATE USER 'readonly_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT ON database_name.* TO 'readonly_user'@'localhost';
FLUSH PRIVILEGES;
```

Este código crea un usuario `readonly_user` con una contraseña y le otorga permisos de solo lectura, específicamente solo usar `SELECT`, en todas las tablas de `database_name`.

El uso de **procedimientos almacenados** también puede ser beneficioso. Los procedimientos almacenados encapsulan las operaciones de la base de datos y pueden ser diseñados para aceptar solo parámetros específicos, lo que reduce la superficie de ataque.

Ejemplo de creación y uso de un procedimiento almacenado en MySQL:

```sql
CREATE PROCEDURE GetUser(IN username VARCHAR(50), IN password VARCHAR(50))
    SELECT * FROM users WHERE username = username AND password = password;
```

Para ejecutar este procedimiento desde PHP usando PDO:

```php
$stmt = $pdo->prepare('CALL GetUser(:username, :password)');
$stmt->execute(['username' => $username, 'password' => $password]);
```

Finalmente, implementar **registros y monitoreo** puede ayudar a detectar intentos de inyección SQL. Las herramientas de monitoreo pueden alertar sobre patrones inusuales en las consultas SQL, permitiendo una respuesta rápida a posibles ataques.

## Medidas complementarias contra la inyección SQL

Además de las medidas ya mencionadas, es recomendable implementar ***firewalls* de aplicaciones web** (**WAF**). Un WAF (Web Application Firewall) actúa como una barrera entre el servidor web y los usuarios, inspeccionando y filtrando el tráfico HTTP para detectar y bloquear patrones de ataque, como intentos de inyección SQL. Estos *firewalls* pueden configurarse para reconocer firmas de ataques comunes y proporcionar una capa adicional de seguridad al entorno de la base de datos.

Otra práctica es realizar auditorías y *pentesting* periódicos. Las **auditorías** revisan el código y las configuraciones de seguridad para identificar posibles vulnerabilidades, mientras que el ***pentesting*** simula ataques reales para evaluar la efectividad de las defensas existentes. Estas actividades permiten identificar y corregir debilidades específicas que podrían ser explotadas mediante inyecciones SQL, fortaleciendo así la seguridad de la base de datos.

_Contenido creado por Manuel Ignacio López Quintero_
